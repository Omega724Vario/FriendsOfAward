@rendermode InteractiveServer
@page "/Teilnehmer"
@inject IJSRuntime JS
@inject NavigationManager NavMananger
@using QRCoder;
@using System.Diagnostics
@using System.Text


<PageTitle>Teilnehmer</PageTitle>

<h2 class="underlined">QR-Codes:</h2>

<div class="input-container">
    <label for="qrCode_Number">Anzahl:</label>
    <input class="ui-input" id="qrCode_Number" type="number" @bind="qrCode_Number" min="1" max="999" />
    <span class="@(string.IsNullOrEmpty(errorMessage) ? "" : "errorMessage")">@errorMessage</span>

    <div>
        <button class="ui-btn primary mr" type="button" @onclick="Btn_QRCodesGenerieren">QR-Codes erstellen</button>

        @if (qrCodeList.Count > 0)
        {
            <button class="ui-btn btn_generateQRCode" @onclick="DownloadHtml">
                QR-Codes herunterladen
            </button>
        }

        @if (isLoading)
        {
            <div class="ui-spinner primary mt">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#000000" viewBox="0 0 256 256"><path d="M232,128a104,104,0,0,1-208,0c0-41,23.81-78.36,60.66-95.27a8,8,0,0,1,6.68,14.54C60.15,61.59,40,93.27,40,128a88,88,0,0,0,176,0c0-34.73-20.15-66.41-51.34-80.73a8,8,0,0,1,6.68-14.54C208.19,49.64,232,87,232,128Z"></path></svg>
            </div>
        }
    </div>
</div>

@if (!isLoading)
{
    <div style="display:flex; flex-wrap: wrap; gap:12px; margin-top: 12px;">
        @for (int i = 0; i < qrCodeList.Count; i++)
        {
            <div style="text-align:center;" class="ui-card">
                <img src="data:image/png;base64,@qrCodeList[i]" style="width:180px; height:180px; border-radius:var(--radius);" class="mb" />
                <div>@passwordList[i]</div>
            </div>
        }
    </div>
}

@code {
    private string btnClick = "";
    private int qrCode_Number = 1;
    private string errorMessage;
    private List<dynamic> qrCodeList = new();
    private List<string> passwordList = new();
    private string? QrPngBase64;
    private bool isLoading = false;



    protected override void OnInitialized()
    {
    }


    private async Task Btn_QRCodesGenerieren()
    {
        isLoading = true;
        StateHasChanged();
        await Task.Yield();

        string password = "";
        errorMessage = "";
        if (qrCode_Number < 1 || qrCode_Number > 999)
        {
            errorMessage = "Bitte gültige Anzahl eingeben (1-999)";
            isLoading = false;
            StateHasChanged();
            return;
        }
        qrCodeList.Clear();
        passwordList.Clear();
        for (int i = 0; i < qrCode_Number; i++)
        {
            password = Guid.NewGuid().ToString();
            password = password.Substring(0, 8);
            Debug.Write("Passwort: " + password + "\n");
            passwordList.Add(password);


            var UrlPayloud = new PayloadGenerator.Url(NavMananger.BaseUri + "User/" + password);
            string payload = UrlPayloud.ToString();

            QRCodeGenerator qrGenerator = new QRCodeGenerator();
            QRCodeData qrCodeData = qrGenerator.CreateQrCode(payload, QRCodeGenerator.ECCLevel.Q);
            QRCode qrCode = new QRCode(qrCodeData);

            using (var qrCodeAsBitmap = qrCode.GetGraphic(20))
            {
                using (var ms = new MemoryStream())
                {
                    qrCodeAsBitmap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                    string base64 = Convert.ToBase64String(ms.ToArray());
                    qrCodeList.Add(base64);
                    Console.WriteLine($"Base64 length: {base64.Length}");
                }
            }
        }
        isLoading = false;

        //FoA_QrCodes.SaveQRtoDb(passwordList);

        StateHasChanged();
    }

    private async Task DownloadHtml()
    {
        var sb = new StringBuilder();

        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html lang=\"de\"><head><meta charset=\"UTF-8\"><title>QR-Codes</title>");
        sb.AppendLine("<style>body{text-align:center;font-family:Arial;} img{width:250px;height:250px;border:1px solid #ccc;} button{margin:10px;padding:10px;}</style>");
        sb.AppendLine("</head><body>");
        sb.AppendLine("<h1>QR-Codes</h1>");
        sb.AppendLine("<img id=\"qrImage\" src=\"\" alt=\"QR-Code\" />");
        sb.AppendLine("<div id=\"qrLabel\"></div>");
        sb.AppendLine("<div><button onclick=\"prevCode()\">Zurück</button><button onclick=\"nextCode()\">Weiter</button></div>");
        sb.AppendLine("<script>");
        sb.AppendLine("const qrCodeIds = [];");
        sb.AppendLine("const qrCodes = [];");

        for (int i = 0; i < qrCodeList.Count; i++)
        {
            var safe = qrCodeList[i]
            .Replace("\\", "\\\\")
                .Replace("\"", "\\\"")
                .Replace("'", "\\'")
                .Replace("</script>", "<\\/script>");

            sb.AppendLine($"qrCodes.push(\"data:image/png;base64,{safe}\");");
            sb.AppendLine($"qrCodeIds.push(\"{passwordList[i]}\")");
        }

        sb.AppendLine("let currentIndex = 0;");
        sb.AppendLine("function showCode(i){document.getElementById('qrImage').src=qrCodes[i];document.getElementById('qrLabel').textContent=qrCodeIds[i];} ");
        sb.AppendLine("function prevCode(){if(currentIndex>0){currentIndex--;showCode(currentIndex);}} ");
        sb.AppendLine("function nextCode(){if(currentIndex<qrCodes.length-1){currentIndex++;showCode(currentIndex);}} ");
        sb.AppendLine("showCode(currentIndex);");
        sb.AppendLine("</script>");
        sb.AppendLine("</body></html>");

        var html = sb.ToString();
        var bytes = Encoding.UTF8.GetBytes(html);
        var base64 = Convert.ToBase64String(bytes);

        Console.WriteLine("HTML size: " + html.Length);


        await JS.InvokeVoidAsync("downloadHtmlFile", "qrcodes.html", html);
    }

}