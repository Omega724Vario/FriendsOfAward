@page "/Diplomarbeiten"
@using ClosedXML.Excel
@rendermode InteractiveServer

<PageTitle>Diplomarbeiten</PageTitle>

<form>
    <label class="ui-drop-area shadow">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#000000" viewBox="0 0 256 256"><path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM152,88V44l44,44Z"></path></svg>
        Dateien hier ablegen oder klicken
        <InputFile OnChange="SelectedFile"
                   class="ui-drop-input"
                   accept=".xlsx"
                   multiple="false" />
    </label>

    <button class="ui-btn primary mt mb" type="button" @onclick="Btn_DAEinlesen">Diplomarbeiten einlesen</button>

    <p>@comment</p>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    @if (isProcessing)
    {
        <div class="ui-spinner primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#000000" viewBox="0 0 256 256"><path d="M232,128a104,104,0,0,1-208,0c0-41,23.81-78.36,60.66-95.27a8,8,0,0,1,6.68,14.54C60.15,61.59,40,93.27,40,128a88,88,0,0,0,176,0c0-34.73-20.15-66.41-51.34-80.73a8,8,0,0,1,6.68-14.54C208.19,49.64,232,87,232,128Z"></path></svg>
        </div>
        @* <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div> *@
    }
    <!--Eingescannte Datensätze anzeigen-->
    <table>
        @if (result.Count != 0)
        {
            <tr>
                <th>Nr</th>
                <th>Abteilung</th>
                <th>Titel</th>
                <th>Schüler</th>
            </tr>

            @foreach (FoA_DA da in result)
            {
                <tr>
                    <td> @da.ID </td>
                    <td> @da.Abteilung </td>
                    <td> @da.Titel </td>
                    <td> @da.Schueler </td>
                </tr>
            }
        }    
    </table>
</form>

@code {
    private IBrowserFile? uploadedFile;
    private string comment = "";
    private string errorMessage = "";
    private bool isProcessing = false;
    List<FoA_DA> result = new List<FoA_DA>();


    // Datei wird in variable gespeichert
    async Task SelectedFile(InputFileChangeEventArgs e)
    {
        try
        {
            uploadedFile = e.File;
            comment = $"Excel-Datei geladen: {uploadedFile.Name}";
            errorMessage = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Laden der Datei: {ex.Message}";
            StateHasChanged();
        }
    }

    /*
    Ein Admin kann eine Excel-Datei in die Datenbank laden, mit den Spalten:
    Nr|AbteilungKürzel|Titel|Autor:innen
    Das ist dann die aktuelle Liste der Diplomarbeiten zur Auswahl.
    Beim Laden wird der aktuelle Inhalt in der DB vollständig ersetzt.
*/
    async Task Btn_DAEinlesen()
    {
        if (uploadedFile == null)
        {
            comment = "Keine Excel-Datei ausgewählt";
            StateHasChanged();
            return;
        }
        // Excel Datei wurde ausgewählt
        isProcessing = true;
        errorMessage = "";
        StateHasChanged();
        try
        {
            //Inhalt wird gelesen und geprüft
            List<FoA_DA> list = await ReadFile(uploadedFile);

            if(list.Count == 0)
            {
                comment = "Keine Daten in der Excel-Datei gefunden";
                StateHasChanged();
                isProcessing = false;
                return; 
            }
            // Datei hat Inhalt und kann in DB gespeichert werden
            bool isWorking = FoA_DA.SaveDAtoDb(list);
            comment = isWorking ? "Upload erfolgreich" : "Fehler beim Speichern";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler: {ex.Message}";
            comment = "Einlesen fehlgeschlagen";
            isProcessing = false;
            StateHasChanged();
        } 
        isProcessing = false;
        StateHasChanged();
    }

    async Task<List<FoA_DA>> ReadFile(IBrowserFile file)
    {
        try
        {
            using Stream? stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); //max size = 10MB (damit Benutzer ned zu große Datein hochladen können)
            using MemoryStream memorystream = new MemoryStream();
            await stream.CopyToAsync(memorystream);
            memorystream.Position = 0; 
            using IXLWorkbook workbook = new XLWorkbook(memorystream); //workbook == excel object
            IXLWorksheet sheet = workbook.Worksheets.First();

            var rows = sheet.RangeUsed().RowsUsed().Skip(1); //alle verwendeten Zeilen/Spalten (erste mit Überschrift wird geskipped)

            foreach (var row in rows)
            {
                if (!string.IsNullOrEmpty(row.Cell(1).GetString()) &&
                !string.IsNullOrEmpty(row.Cell(2).GetString()))
                {
                    result.Add(new FoA_DA(
                        row.Cell(1).GetValue<int>(),
                        row.Cell(2).GetString(),
                        row.Cell(3).GetString(),
                        row.Cell(4).GetString()
                    ));
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler: {ex.Message}";
            comment = "Inhalt fehlerhaft";
            StateHasChanged();
        }
        
        return result;
    }
}